import time
import os
import sys
import logging
import traceback
from datetime import datetime
from decimal import Decimal

# ê³µí†µ ëª¨ë“ˆ Import
sys.path.append(os.path.dirname(os.path.dirname(__file__)))
from module import upbit

# -----------------------------------------------------------------------------
# - Name : start_buytrade
# - Desc : ë§¤ìˆ˜ ë¡œì§
# - Input
# 1) buy_amt : ë§¤ìˆ˜ê¸ˆì•¡
# -----------------------------------------------------------------------------
def start_buytrade(buy_amt):
    try:
        # í”„ë¡œê·¸ë¨ ì‹œì‘ ë©”ì„¸ì§€ ë°œì†¡
        message = '\n\n[ğŸ”´ğŸŸ¥ ì‹œì‘ ì•ˆë‚´ ğŸŸ¥ğŸ”´]'
        message = message + '\n\n buy_bot ì‹œì‘! '
        message = message + '\n\n- í˜„ì¬ì‹œê°„:' + str(datetime.today().strftime('%Y-%m-%d %H:%M:%S'))

        # í”„ë¡œê·¸ë¨ ì‹œì‘ ë©”ì„¸ì§€ ë°œì†¡
        upbit.send_telegram_message(message)

        # ---------------------------------------------------------------------
        # ì•Œë¦¼ ë°œì†¡ ìš© ë³€ìˆ˜
        # ---------------------------------------------------------------------
        sent_list = []
        # ---------------------------------------------------------------------

        # ----------------------------------------------------------------------
        # ë°˜ë³µ ìˆ˜í–‰
        # ----------------------------------------------------------------------
        while True:
            time.sleep(0.3)
            logging.info("*********************************************************")
            logging.info("1. ë¡œê·¸ë ˆë²¨ : " + str(log_level))
            logging.info("2. ë§¤ìˆ˜ê¸ˆì•¡ : " + str(buy_amt))
            logging.info("*********************************************************")

            # -----------------------------------------------------------------
            # ì „ì²´ ì¢…ëª© ë¦¬ìŠ¤íŠ¸ ì¶”ì¶œ
            # -----------------------------------------------------------------
            target_items = upbit.get_items('KRW', '')

            # -----------------------------------------------------------------
            # ì¢…ëª©ë³„ ì²´í¬
            # -----------------------------------------------------------------
            for target_item in target_items:
                # ì§€í‘œ Falseë¡œ ì´ˆê¸°í™”
                rsi_val = False
                mfi_val = False
                ocl_val = False
                logging.info('ì²´í¬ì¤‘....[' + str(target_item['market']) + ']')

                # -------------------------------------------------------------
                # ì¢…ëª©ë³„ ë³´ì¡°ì§€í‘œë¥¼ ì¡°íšŒ
                # 1. ì¡°íšŒ ê¸°ì¤€ : ì¼ìº”ë“¤, ìµœê·¼ 5ê°œ ì§€í‘œ ì¡°íšŒ
                # 2. ì†ë„ë¥¼ ìœ„í•´ ì›í•˜ëŠ” ì§€í‘œë§Œ ì¡°íšŒ(RSI, MFI, MACD, CANDLE)
                # -------------------------------------------------------------
                indicators = upbit.get_indicator_sel(target_item['market'], 'D', 200, 5,['RSI', 'MFI', 'MACD', 'CANDLE'])

                # --------------------------------------------------------------
                # ìµœê·¼ ìƒì¥í•˜ì—¬ ìº”ë“¤ ê°¯ìˆ˜ ë¶€ì¡±ìœ¼ë¡œ ë³´ì¡° ì§€í‘œë¥¼ êµ¬í•˜ê¸° ì–´ë ¤ìš´ ê±´ì€ ì œì™¸
                # --------------------------------------------------------------
                if 'CANDLE' not in indicators or len(indicators['CANDLE']) < 200:
                    logging.info('ìº”ë“¤ ë°ì´í„° ë¶€ì¡±ìœ¼ë¡œ ë°ì´í„° ì‚°ì¶œ ë¶ˆê°€...[' + str(target_item['market']) + ']')
                    
                    continue

                # --------------------------------------------------------------
                # ë³´ì¡° ì§€í‘œ ì¶”ì¶œ
                # --------------------------------------------------------------
                rsi = indicators['RSI']
                mfi = indicators['MFI']
                macd = indicators['MACD']
                candle = indicators['CANDLE']

                # --------------------------------------------------------------
                # ë§¤ìˆ˜ ë¡œì§
                # 1. RSI : 2ì¼ì „ < 30ë¯¸ë§Œ, 3ì¼ì „ > 2ì¼ì „, 1ì¼ì „ > 2ì¼ì „, í˜„ì¬ > 1ì¼ì „
                # 2. MFI : 2ì¼ì „ < 20ë¯¸ë§Œ, 3ì¼ì „ > 2ì¼ì „, 1ì¼ì „ > 2ì¼ì „, í˜„ì¬ > 1ì¼ì „
                # 3. MACD(OCL) : 3ì¼ì „ < 0, 2ì¼ì „ < 0, 1ì¼ì „ < 0, 3ì¼ì „ > 2ì¼ì „, 1ì¼ì „ > 2ì¼ì „, í˜„ì¬ > 1ì¼ì „
                # --------------------------------------------------------------

                # --------------------------------------------------------------
                # RSI : 2ì¼ì „ < 30ë¯¸ë§Œ, 3ì¼ì „ > 2ì¼ì „, 1ì¼ì „ > 2ì¼ì „, í˜„ì¬ > 1ì¼ì „
                # rsi[0]['RSI'] : í˜„ì¬
                # rsi[1]['RSI'] : 1ì¼ì „
                # rsi[2]['RSI'] : 2ì¼ì „
                # rsi[3]['RSI'] : 3ì¼ì „
                # --------------------------------------------------------------
                if (Decimal(str(rsi[0]['RSI'])) > Decimal(str(rsi[1]['RSI'])) > Decimal(str(rsi[2]['RSI']))
                        and Decimal(str(rsi[3]['RSI'])) > Decimal(str(rsi[2]['RSI']))
                        and Decimal(str(rsi[2]['RSI'])) < Decimal(str(30))):
                    rsi_val = True

                # --------------------------------------------------------------
                # MFI : 2ì¼ì „ < 20ë¯¸ë§Œ, 3ì¼ì „ > 2ì¼ì „, 1ì¼ì „ > 2ì¼ì „, í˜„ì¬ > 1ì¼ì „
                # mfi[0]['MFI'] : í˜„ì¬
                # mfi[1]['MFI'] : 1ì¼ì „
                # mfi[2]['MFI'] : 2ì¼ì „
                # mfi[3]['MFI'] : 3ì¼ì „
                # --------------------------------------------------------------
                if (Decimal(str(mfi[0]['MFI'])) > Decimal(str(mfi[1]['MFI'])) > Decimal(str(mfi[2]['MFI']))
                        and Decimal(str(mfi[3]['MFI'])) > Decimal(str(mfi[2]['MFI']))
                        and Decimal(str(mfi[2]['MFI'])) < Decimal(str(20))):
                    mfi_val = True

                # --------------------------------------------------------------
                # MACD(OCL) : 3ì¼ì „ < 0, 2ì¼ì „ < 0, 1ì¼ì „ < 0, 3ì¼ì „ > 2ì¼ì „, 1ì¼ì „ > 2ì¼ì „, í˜„ì¬ > 1ì¼ì „
                # macd[0]['OCL'] : í˜„ì¬
                # macd[1]['OCL'] : 1ì¼ì „
                # macd[2]['OCL'] : 2ì¼ì „
                # macd[3]['OCL'] : 3ì¼ì „
                # --------------------------------------------------------------
                if (Decimal(str(macd[0]['OCL'])) > Decimal(str(macd[1]['OCL'])) > Decimal(str(macd[2]['OCL']))
                        and Decimal(str(macd[3]['OCL'])) > Decimal(str(macd[2]['OCL']))
                        and Decimal(str(macd[1]['OCL'])) < Decimal(str(0))
                        and Decimal(str(macd[2]['OCL'])) < Decimal(str(0))
                        and Decimal(str(macd[3]['OCL'])) < Decimal(str(0))):
                    ocl_val = True

                # --------------------------------------------------------------
                # ë§¤ìˆ˜ëŒ€ìƒ ë°œê²¬
                # --------------------------------------------------------------
                if rsi_val and mfi_val and ocl_val:
                    upbit.send_telegram_message("ğŸ”´ğŸŸ¥"+target_item['market']+"ë§¤ìˆ˜ ëŒ€ìƒ ë°œê²¬ğŸŸ¥ğŸ”´")
                    logging.info('ë§¤ìˆ˜ëŒ€ìƒ ë°œê²¬....[' + str(target_item['market']) + ']')
                    logging.info('RSI : ' + str(rsi))
                    logging.info('MFI : ' + str(mfi))
                    logging.info('MACD : ' + str(macd))

                    # ------------------------------------------------------------------
                    # ê¸°ë§¤ìˆ˜ ì—¬ë¶€ íŒë‹¨
                    # ------------------------------------------------------------------
                    accounts = upbit.get_accounts('Y', 'KRW')
                    account = list(filter(lambda x: x.get('market') == target_item['market'], accounts))

                    # ì´ë¯¸ ë§¤ìˆ˜í•œ ì¢…ëª©ì´ë©´ ë‹¤ì‹œ ë§¤ìˆ˜í•˜ì§€ ì•ŠìŒ
                    # sell_bot.pyì—ì„œ ë§¤ë„ ì²˜ë¦¬ë˜ë©´ ë³´ìœ  ì¢…ëª©ì—ì„œ ì‚¬ë¼ì§€ê³  ë‹¤ì‹œ ë§¤ìˆ˜ ê°€ëŠ¥
                    if len(account) >= 1:
                        logging.info('ê¸° ë§¤ìˆ˜ ì¢…ëª©ìœ¼ë¡œ ë§¤ìˆ˜í•˜ì§€ ì•ŠìŒ....[' + str(target_item['market']) + ']')
                        continue

                    # ------------------------------------------------------------------
                    # ë§¤ìˆ˜ê¸ˆì•¡ ì„¤ì •
                    # 1. M : ìˆ˜ìˆ˜ë£Œë¥¼ ì œì™¸í•œ ìµœëŒ€ ê°€ëŠ¥ KRW ê¸ˆì•¡ë§Œí¼ ë§¤ìˆ˜
                    # 2. ê¸ˆì•¡ : ì…ë ¥í•œ ê¸ˆì•¡ë§Œí¼ ë§¤ìˆ˜
                    # ------------------------------------------------------------------
                    available_amt = upbit.get_krwbal()['available_krw']

                    if buy_amt == '12345':
                        buy_amt = available_amt

                    # ------------------------------------------------------------------
                    # ì…ë ¥ ê¸ˆì•¡ì´ ì£¼ë¬¸ ê°€ëŠ¥ê¸ˆì•¡ë³´ë‹¤ ì‘ìœ¼ë©´ ì¢…ë£Œ
                    # ------------------------------------------------------------------
                    if Decimal(str(available_amt)) < Decimal(str(buy_amt)):
                        logging.info('ì£¼ë¬¸ ê°€ëŠ¥ê¸ˆì•¡[' + str(available_amt) + ']ì´ ì…ë ¥í•œ ì£¼ë¬¸ê¸ˆì•¡[' + str(buy_amt) + '] ë³´ë‹¤ ì‘ìŠµë‹ˆë‹¤.')
                        continue

                    # ------------------------------------------------------------------
                    # ìµœì†Œ ì£¼ë¬¸ ê¸ˆì•¡(ì—…ë¹„íŠ¸ ê¸°ì¤€ 5000ì›) ì´ìƒì¼ ë•Œë§Œ ë§¤ìˆ˜ë¡œì§ ìˆ˜í–‰
                    # ------------------------------------------------------------------
                    if Decimal(str(buy_amt)) < Decimal(str(upbit.min_order_amt)):
                        logging.info('ì£¼ë¬¸ê¸ˆì•¡[' + str(buy_amt) + ']ì´ ìµœì†Œ ì£¼ë¬¸ê¸ˆì•¡[' + str(upbit.min_order_amt) + '] ë³´ë‹¤ ì‘ìŠµë‹ˆë‹¤.')
                        continue

                    # ------------------------------------------------------------------
                    # ì‹œì¥ê°€ ë§¤ìˆ˜
                    # ì‹¤ì œ ë§¤ìˆ˜ ë¡œì§ì€ ì•ˆì „ì„ ìœ„í•´ ì£¼ì„ì²˜ë¦¬ í•˜ì˜€ìŠµë‹ˆë‹¤.
                    # ì‹¤ì œ ë§¤ë§¤ë¥¼ ì›í•˜ì‹œë©´ í…ŒìŠ¤íŠ¸ë¥¼ ì¶©ë¶„íˆ ê±°ì¹œ í›„ ì£¼ì„ì„ í•´ì œí•˜ì‹œë©´ ë©ë‹ˆë‹¤.
                    # ------------------------------------------------------------------
                    #logging.info('ì‹œì¥ê°€ ë§¤ìˆ˜ ì‹œì‘! [' + str(target_item['market']) + ']')
                    rtn_buycoin_mp = upbit.buycoin_mp(target_item['market'], buy_amt)
                    upbit.send_telegram_message("ğŸ”´ğŸŸ¥"+target_item['market']+"êµ¬ë§¤ ì™„ë£ŒğŸŸ¥ğŸ”´")
                    upbit.send_telegram_message('\n- í˜„ì¬ê°€: ' + str(target_item['trade_price']))
                    #logging.info('ì‹œì¥ê°€ ë§¤ìˆ˜ ì¢…ë£Œ! [' + str(target_item['market']) + ']')
                    #logging.info(rtn_buycoin_mp)

    # ---------------------------------------
    # ëª¨ë“  í•¨ìˆ˜ì˜ ê³µí†µ ë¶€ë¶„(Exception ì²˜ë¦¬)
    # ----------------------------------------
    except Exception:
        raise


# -----------------------------------------------------------------------------
# - Name : main
# - Desc : ë©”ì¸
# -----------------------------------------------------------------------------
if __name__ == '__main__':

    # noinspection PyBroadException
    try:

        # ---------------------------------------------------------------------
        # ì…ë ¥ ë°›ì„ ë³€ìˆ˜
        #
        # 1. ë¡œê·¸ë ˆë²¨
        #   1) ë ˆë²¨ ê°’ : D:DEBUG, E:ERROR, ê·¸ ì™¸:INFO
        #
        # 2. ë§¤ìˆ˜ê¸ˆì•¡
        #   1) M : ìˆ˜ìˆ˜ë£Œë¥¼ ì œì™¸í•œ ìµœëŒ€ ê°€ëŠ¥ ê¸ˆì•¡ìœ¼ë¡œ ë§¤ìˆ˜
        #   2) ê¸ˆì•¡ : ì…ë ¥í•œ ê¸ˆì•¡ë§Œ ë§¤ìˆ˜(ìˆ˜ìˆ˜ë£Œ í¬í•¨)
        #
        # 3. ë§¤ìˆ˜ ì œì™¸ì¢…ëª©
        #   1) ì¢…ëª©ì½”ë“œ(ì½¤ë§ˆêµ¬ë¶„ì) : BTC,ETH
        # ---------------------------------------------------------------------

        # 1. ë¡œê·¸ë ˆë²¨
        log_level = "INFO"
        buy_amt = 12345

        upbit.set_loglevel(log_level)

        logging.info("*********************************************************")
        logging.info("1. ë¡œê·¸ë ˆë²¨ : " + str(log_level))
        logging.info("2. ë§¤ìˆ˜ê¸ˆì•¡ : " + str(buy_amt))
        logging.info("*********************************************************")

        # ë§¤ìˆ˜ ë¡œì§ ì‹œì‘
        start_buytrade(buy_amt)

    except KeyboardInterrupt:
        # í”„ë¡œê·¸ë¨ ì¢…ë£Œ ë©”ì„¸ì§€ ì¡°ë¦½
        message = '\n\n[ğŸš¨âŒğŸš¨ì¢…ë£ŒğŸš¨âŒğŸš¨]'
        message = message + '\n\n buy_bot ì¢…ë£Œ!'
        message = message + '\n\n- í˜„ì¬ì‹œê°„:' + str(datetime.today().strftime('%Y-%m-%d %H:%M:%S'))
        # í”„ë¡œê·¸ë¨ ì¢…ë£Œ ë©”ì„¸ì§€ ë°œì†¡
        upbit.send_telegram_message(message)
        
        logging.error("KeyboardInterrupt Exception ë°œìƒ!")
        logging.error(traceback.format_exc())
        sys.exit(-100)

    except Exception:
        # í”„ë¡œê·¸ë¨ ì¢…ë£Œ ë©”ì„¸ì§€ ì¡°ë¦½
        message = '\n\n[ğŸš¨âŒğŸš¨ì¢…ë£ŒğŸš¨âŒğŸš¨]'
        message = message + '\n\n buy_bot ì¢…ë£Œ!'
        message = message + '\n\n- í˜„ì¬ì‹œê°„:' + str(datetime.today().strftime('%Y-%m-%d %H:%M:%S'))
        # í”„ë¡œê·¸ë¨ ì¢…ë£Œ ë©”ì„¸ì§€ ë°œì†¡
        upbit.send_telegram_message(message)
        
        logging.error("Exception ë°œìƒ!")
        logging.error(traceback.format_exc())
        sys.exit(-200)